# 과거 습관 보기 기능 구현 계획

## 개요

기간이 지나서 더 이상 수행할 필요가 없는 습관들을 확인하고 통계를 리뷰할 수 있는 기능을 추가합니다.

## 목표

- 기간이 지난 습관들을 별도 페이지에서 확인 가능
- 각 과거 습관의 통계 정보를 한눈에 파악
- 간결한 카드 UI로 정보 표시

## 스펙

### 페이지 경로
- `/habits/archive`

### 표시 조건
- `end_date < 오늘` 인 습관들만 표시
- 즉, 종료일이 지난 습관들

### UI 디자인: 간결한 카드

```
┌─────────────────────────────────────┐
│ [색상 인디케이터] 매일 운동하기      │
│                                      │
│ 달성률: 75%  |  최대 연속: 30일     │
│ 45일 / 60일 완료                    │
│ 2025-01-01 ~ 2025-03-01             │
└─────────────────────────────────────┘
```

### 카드 구성 요소

1. **색상 인디케이터**: 왼쪽 테두리 또는 배경 (습관별 색상)
2. **제목**: 습관 제목 (큰 글씨)
3. **설명**: 습관 설명 (작은 글씨, 선택, 있으면 표시)
4. **통계 정보**:
   - **총 달성률**: 완료율 퍼센트 (예: "75%")
   - **최대 연속 달성 일수**: 최대 연속 달성 일수 (예: "최대 연속: 30일" 또는 "🔥 30일")
   - **총 완료 일수 / 총 일수**: 구체적인 수치 (예: "45일 / 60일 완료")
   - **기간**: 시작일 ~ 종료일 (예: "2025-01-01 ~ 2025-03-01")

### 통계 계산 로직

- **총 달성률**: `(완료한 일수 / 총 일수) × 100`
- **총 일수**: 습관 기간 내 수행해야 하는 날짜 수 (요일 필터링 적용)
  - `start_date`부터 `end_date`까지의 날짜 중 `weekdays`에 포함된 날짜만 카운트
- **완료한 일수**: `habit_records`에서 `completed = true`인 레코드 수
- **최대 연속 달성 일수**: 전체 기간 중 최대 연속으로 `completed = true`인 일수

### 인터랙션

- 카드 클릭 → 상세 페이지 이동 (`/habits/detail?id=xxx`)
- 상세 페이지에서 통계와 달력 뷰 확인 가능
- 삭제 기능은 상세 페이지에서만 가능 (확인 모달 포함)

### 레이아웃

- 현재 습관 목록과 동일한 반응형 그리드 레이아웃 사용
- 모바일 세로: 1열
- 모바일 가로/태블릿: 2-3열
- 데스크톱: 3-4열

### 정렬

- 기본 정렬: 최신순 (종료일이 최근인 것부터)
- 정렬 옵션은 제공하지 않음 (간결성 유지)

### 빈 상태

- 과거 습관이 없을 때: "과거 습관이 없습니다" 메시지 표시

### 네비게이션

- 헤더에 "← 습관 목록" 링크로 `/habits`로 돌아가기
- `/habits` 페이지 헤더에 "과거 습관" 링크 추가

## 구현 작업

### 1단계: 페이지 구조 및 데이터 패칭

1. **파일 생성**: `/src/app/habits/archive/page.tsx`
2. **습관 데이터 패칭**:
   - **HabitsProvider 캐시 활용**: `useHabitsContext()`로 `habits` Map 가져오기
   - **중요**: HabitsProvider의 `fetchAllHabits()`는 **모든 습관을 가져옵니다** (과거 습관 포함)
     - 날짜 필터링 없이 `user_id`로만 필터링하여 모든 습관 조회
     - 따라서 캐시에는 현재 진행 중인 습관뿐만 아니라 과거 습관도 모두 포함됨
   - 캐시에 습관이 없으면 `fetchAllHabits()` 호출하여 초기 로드
   - `habitsCache.values()`를 배열로 변환
   - `end_date < 오늘` 조건으로 필터링하여 과거 습관만 추출 (날짜 문자열 비교: `compareDateStrings`)
   - 종료일 기준 내림차순 정렬 (최신순)
   - **중요**: 습관 데이터는 HabitsProvider 캐시에서만 가져오고, DB 직접 패칭하지 않음
3. **통계 계산 함수**:
   - 각 습관별로 `habit_records` 패칭 필요 (통계 계산을 위해)
   - `HabitStats` 컴포넌트의 로직 재사용
   - 각 습관 카드에서 개별적으로 통계 계산 (또는 페이지 레벨에서 배치 처리)
   - **패칭 전략**:
     - 옵션 A: 각 카드 컴포넌트에서 개별 패칭 (HabitStats 방식)
     - 옵션 B: 페이지 레벨에서 모든 습관의 기록을 한 번에 패칭 (성능 최적화)
   - **권장**: 옵션 A (간단하고 기존 패턴과 일관성 유지)

### 2단계: UI 컴포넌트

1. **과거 습관 카드 컴포넌트** (`PastHabitCard.tsx`):
   - 현재 `HabitCard`와 유사하지만 완료 체크 버튼 없음
   - 통계 정보 표시
   - 클릭 시 상세 페이지로 이동
2. **페이지 레이아웃**:
   - 헤더 (제목, 뒤로가기 링크)
   - 습관 카드 그리드
   - 빈 상태 처리

### 3단계: 네비게이션 통합

1. **습관 목록 페이지** (`/habits/page.tsx`):
   - 헤더에 "과거 습관" 링크 추가
2. **과거 습관 페이지** (`/habits/archive/page.tsx`):
   - 헤더에 "← 습관 목록" 링크 추가

### 4단계: 통계 계산 최적화

1. **통계 계산 로직**:
   - 각 습관별로 `habit_records` 패칭 (HabitsProvider 캐시에는 기록이 없음)
   - 습관 기간 내 모든 기록 가져오기: `gte('date', start_date).lte('date', end_date)`
   - 통계 계산 (달성률, 최대 연속 일수 등)
   - `useMemo`로 계산 결과 캐싱 (선택사항)
2. **성능 고려사항**:
   - 습관이 많을 경우를 대비한 로딩 상태 처리
   - 통계 계산은 클라이언트 사이드에서 수행
   - 각 카드별로 개별 로딩 상태 표시 가능 (HabitStats 방식)
3. **캐싱 전략**:
   - **습관 데이터**: HabitsProvider 캐시 활용 (중복 패칭 없음)
   - **기록 데이터**: 캐싱하지 않음 (각 컴포넌트에서 필요 시 패칭)
   - 과거 습관은 더 이상 변경되지 않으므로, 한 번 패칭하면 재패칭 불필요 (선택적 최적화)

## 기술 스택

- Next.js 16 (App Router)
- React 19
- TypeScript
- Tailwind CSS 4
- HabitsProvider (캐시 활용)
- Supabase (데이터 패칭)

## 예상 작업 시간

- 1단계: 페이지 구조 및 데이터 패칭 (1-2시간)
- 2단계: UI 컴포넌트 (2-3시간)
- 3단계: 네비게이션 통합 (30분)
- 4단계: 통계 계산 최적화 (1-2시간)

**총 예상 시간**: 4-7시간 (약 1일)

## 참고 문서

- `docs/HABITS_DESIGN.md` 섹션 3.2.1 (과거 습관 목록 스펙)
- `docs/ROADMAP.md` Phase 1.4 (습관 목록 화면)
- 기존 컴포넌트:
  - `src/app/components/habits/HabitCard.tsx` (카드 UI 참고)
  - `src/app/components/habits/HabitStats.tsx` (통계 계산 로직 참고)
  - `src/app/habits/page.tsx` (페이지 구조 참고)

## 체크리스트

- [ ] `/habits/archive/page.tsx` 페이지 생성
- [ ] HabitsProvider 캐시에서 습관 데이터 가져오기 (`useHabitsContext`)
- [ ] 캐시에 없으면 `fetchAllHabits()` 호출
- [ ] 과거 습관 필터링 로직 구현 (`end_date < 오늘`, `compareDateStrings` 사용)
- [ ] 종료일 기준 내림차순 정렬
- [ ] 각 습관별 `habit_records` 패칭 로직 구현
- [ ] 통계 계산 함수 구현 (HabitStats 로직 재사용)
- [ ] `PastHabitCard` 컴포넌트 생성
- [ ] 반응형 그리드 레이아웃 적용
- [ ] 빈 상태 처리
- [ ] 네비게이션 링크 추가 (양방향: `/habits` ↔ `/habits/archive`)
- [ ] HabitsProvider 캐시 활용 확인 (습관 데이터는 캐시에서만)
- [ ] 로딩 상태 처리 (각 카드별 또는 페이지 레벨)
- [ ] 다크모드 지원 확인
- [ ] 모바일 반응형 확인
