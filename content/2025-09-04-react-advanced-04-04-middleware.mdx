---
title: "[Next.js 고급 4/7] Next.js 고급 - Middleware"
date: "2025-09-09"
description: "Next.js Middleware로 요청 가로채기"
tags: ["Next.js", "React", "고급", "프론트엔드"]
series: "Next.js 고급"
seriesOrder: 4
---

# Next.js 고급 - Middleware

> Middleware는 요청이 라우트에 도달하기 전에 실행되는 가장 앞단의 훅이다.  
> 목적은 렌더링 이전에 요청을 분기/차단/변형하는 것이다.

---

## Middleware

Middleware는 Edge Runtime에서 실행되는 경우가 많다. 그래서 Node.js API(파일 시스템, 일부 crypto 등)를 마음대로 쓰지 못한다.

실무에서 Middleware는 다음에 주로 쓴다.

- 인증/인가: 로그인 전용 경로 차단, 역할 기반 접근
- 리다이렉트/리라이트: 레거시 URL 유지, A/B 실험
- 국제화: locale prefix 자동 부여
- 보안/관측: 헤더 추가, 간단한 로깅(단, 과도한 로깅은 비용)

반대로 DB 접근 같은 무거운 작업은 Middleware에 두지 않는 편이 기본이다.

### 기본 Middleware

```jsx
// middleware.js
import { NextResponse } from "next/server";
export function middleware(request) {
  // 요청 로깅
  console.log("Request:", request.nextUrl.pathname);
  // 헤더 추가
  const response = NextResponse.next();
  response.headers.set("x-custom-header", "my-value");
  return response;
}
export const config = {
  matcher: ["/dashboard/:path*", "/admin/:path*"],
};
```

`matcher`는 비용 제어 장치다. 모든 요청에 middleware를 태우면 정적 자산까지 영향받는다.

### 인증 Middleware

```jsx
// middleware.js
import { NextResponse } from "next/server";
export function middleware(request) {
  const token = request.cookies.get("token");
  if (!token && request.nextUrl.pathname.startsWith("/dashboard")) {
    return NextResponse.redirect(new URL("/login", request.url));
  }
  return NextResponse.next();
}
export const config = {
  matcher: "/dashboard/:path*",
};
```

### 실무 포인트: open redirect를 막는다

로그인으로 보낼 때 `?from=` 같은 파라미터를 붙이고 싶어진다. 이 값은 반드시 “내부 경로만 허용”하도록 검증해야 한다.

### 국제화 Middleware

```jsx
// middleware.js
import { NextResponse } from "next/server";
const locales = ["en", "ko", "ja"];
const defaultLocale = "en";
export function middleware(request) {
  const pathname = request.nextUrl.pathname;
  // 이미 로케일이 있으면 패스
  const pathnameHasLocale = locales.some(
    (locale) => pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`,
  );
  if (pathnameHasLocale) return;
  // Accept-Language 헤더에서 로케일 가져오기
  const locale =
    request.headers.get("accept-language")?.split(",")[0] || defaultLocale;
  // 로케일 추가하여 리다이렉트
  return NextResponse.redirect(new URL(`/${locale}${pathname}`, request.url));
}
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
};
```

locale middleware는 정적 자산과 API를 matcher에서 제외하는 것이 핵심이다. 제외하지 않으면 이미지 최적화/정적 파일 요청도 locale rewrite 대상이 되어 깨진다.

### A/B 테스트 Middleware

```jsx
// middleware.js
import { NextResponse } from "next/server";
export function middleware(request) {
  // 쿠키에서 버킷 확인
  let bucket = request.cookies.get("bucket");
  if (!bucket) {
    // 랜덤하게 A 또는 B 할당
    bucket = Math.random() < 0.5 ? "a" : "b";
    const response = NextResponse.next();
    response.cookies.set("bucket", bucket);
    return response;
  }
  // 버킷에 따라 다른 페이지로 리라이트
  if (bucket === "b") {
    return NextResponse.rewrite(new URL("/experiment-b", request.url));
  }
  return NextResponse.next();
}
```

### redirect vs rewrite

- redirect: 브라우저 주소창 URL이 바뀐다. 외부로 보인다.
- rewrite: 주소창은 그대로고, 내부에서 다른 라우트로 매칭된다. 실험에는 rewrite가 자주 쓰인다.

---

## Nuxt와 비교

Nuxt도 middleware(라우트 미들웨어, 서버 미들웨어)로 비슷한 문제를 푼다. Next.js의 Middleware는 요청 앞단(Edge)에서 HTTP 단으로 분기한다는 성격이 강하다.

| 관심사 | Nuxt | Next.js |
| --- | --- | --- |
| 인증 가드 | route middleware | Edge middleware + matcher |
| 리다이렉트 | navigateTo | NextResponse.redirect |
| 리라이트 | server/route 설정 | NextResponse.rewrite |
| 실행 환경 | Node/Nitro 중심 | Edge 제약이 강함 |

---
